name: Test CLI Installations

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  test-gh:
    name: Test gh (GitHub CLI)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gh
        shell: bash
          
      - name: Verify gh installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
        shell: bash
          
  test-jira:
    name: Test jira-cli
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install jira
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh jira
        shell: bash
          
      - name: Verify jira installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          jira version
        shell: bash
          
  test-gdrive:
    name: Test gdrive CLI
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gdrive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gdrive
        shell: bash
          
      - name: Verify gdrive installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gdrive version || gdrive --version || echo "gdrive installed at $(which gdrive)"
        shell: bash
          
  test-slack:
    name: Test Slack CLI
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install slack
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh slack
        shell: bash
          
      - name: Verify slack installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          slack version || slack --version
        shell: bash

  test-npx:
    name: Test npx (Node.js LTS)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install npx
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh npx
        shell: bash
          
      - name: Verify npx installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          node --version
          npm --version
          npx --version
        shell: bash
          
  test-aws-linux:
    name: Test AWS CLI (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install aws
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh aws
          
      - name: Verify aws installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          aws --version
          
  test-aws-macos:
    name: Test AWS CLI (macOS - Manual)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Note about macOS AWS CLI
        run: |
          echo "AWS CLI on macOS requires sudo for .pkg installation"
          echo "Skipping automated test - see README for manual installation instructions"
          
  test-aws-windows:
    name: Test AWS CLI (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install aws
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh aws
        shell: bash
        
      - name: Verify aws installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          aws --version
        shell: bash
          
  test-multiple:
    name: Test multiple installations
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gh, jira, slack, and npx together
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gh jira slack npx
        shell: bash
          
      - name: Verify all installations
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          jira version
          slack version || slack --version
          npx --version
        shell: bash
          
  test-skills-listing:
    name: Test skills listing with npx
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install npx
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh npx
          
      - name: List bundled skills
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          npx skills add ./ --list --yes || echo "No skills found (expected for this test repo)"
          
  test-cursor:
    name: Test Cursor (non-interactive)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cursor (AppImage)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh --non-interactive cursor
          
      - name: Verify cursor installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          cursor --version || echo "cursor installed at $(which cursor)"
          file "${HOME}/.local/bin/cursor"
          
  test-opencode:
    name: Test OpenCode (non-interactive)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install opencode (.deb)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./install.sh --non-interactive opencode
          
      - name: Verify opencode installation
        run: |
          which opencode || echo "opencode installed system-wide"
          dpkg -l | grep opencode || echo "opencode package installed"
          
  test-all-linux:
    name: Test 'all' option (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install all CLIs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh all
          
      - name: Verify installations
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          jira version
          aws --version
          gdrive version || gdrive --version || echo "gdrive installed"
          slack version || slack --version
          cursor --version || echo "cursor installed"
          npx --version
          
  test-all-windows:
    name: Test 'all' option (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install all CLIs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh all
        shell: bash
         
      - name: Verify installations
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          jira version
          aws --version
          gdrive version || gdrive --version || echo "gdrive installed"
          slack version || slack --version
          npx --version
        shell: bash
        
  test-path-warning:
    name: Test PATH warning and user experience
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gh without PATH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gh 2>&1 | tee install_output.txt
        shell: bash
        
      - name: Verify PATH warning is shown
        run: |
          if ! grep -q "is not on your PATH" install_output.txt; then
            echo "ERROR: PATH warning not shown to user!"
            exit 1
          fi
          echo "✓ PATH warning correctly shown"
        shell: bash
        
      - name: Verify automatic PATH setup is offered (non-interactive check)
        run: |
          # In CI, stdin is not a tty, so auto-prompt won't appear
          # Just verify the manual instructions are still shown
          if ! grep -q "To add manually" install_output.txt; then
            echo "ERROR: Manual PATH instructions not shown!"
            exit 1
          fi
          echo "✓ Manual PATH instructions shown (CI is non-interactive)"
        shell: bash
        
      - name: Verify command fails without PATH (expected)
        run: |
          if gh --version 2>/dev/null; then
            echo "ERROR: Command should NOT work without PATH!"
            exit 1
          fi
          echo "✓ Command correctly fails without PATH set"
        shell: bash
        continue-on-error: false
        
      - name: Verify command works WITH PATH
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          echo "✓ Command works after PATH is set"
        shell: bash
        
      - name: Test automatic PATH setup with AUTO_PATH=false
        run: |
          export PREFIX="${HOME}/.local/bin"
          export AUTO_PATH=false
          ./install.sh jira 2>&1 | tee auto_path_test.txt
          # Should show manual instructions when AUTO_PATH=false
          if ! grep -q "To add manually" auto_path_test.txt; then
            echo "ERROR: Manual instructions not shown with AUTO_PATH=false!"
            exit 1
          fi
          echo "✓ AUTO_PATH=false correctly skips prompt"
        shell: bash
