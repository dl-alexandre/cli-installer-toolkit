name: Test CLI Installations

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  test-gh:
    name: Test gh (GitHub CLI)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gh
          
      - name: Verify gh installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          
  test-jira:
    name: Test jira-cli
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install jira
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh jira
          
      - name: Verify jira installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          jira version
          
  test-gdrive:
    name: Test gdrive CLI
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gdrive
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gdrive
          
      - name: Verify gdrive installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gdrive version || gdrive --version || echo "gdrive installed at $(which gdrive)"
          
  test-slack:
    name: Test Slack CLI
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install slack
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh slack
          
      - name: Verify slack installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          slack version || slack --version

  test-npx:
    name: Test npx (Node.js LTS)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install npx
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh npx
          
      - name: Verify npx installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          node --version
          npm --version
          npx --version
          
  test-aws-linux:
    name: Test AWS CLI (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install aws
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh aws
          
      - name: Verify aws installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          aws --version
          
  test-aws-macos:
    name: Test AWS CLI (macOS - Manual)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Note about macOS AWS CLI
        run: |
          echo "AWS CLI on macOS requires sudo for .pkg installation"
          echo "Skipping automated test - see README for manual installation instructions"
          
  test-multiple:
    name: Test multiple installations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install gh, jira, slack, and npx together
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh gh jira slack npx
          
      - name: Verify all installations
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          jira version
          slack version || slack --version
          npx --version
          
  test-skills-listing:
    name: Test skills listing with npx
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install npx
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh npx
          
      - name: List bundled skills
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          npx skills add ./ --list --yes
          
  test-cursor:
    name: Test Cursor (non-interactive)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install cursor (AppImage)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh --non-interactive cursor
          
      - name: Verify cursor installation
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          cursor --version || echo "cursor installed at $(which cursor)"
          file "${HOME}/.local/bin/cursor"
          
  test-opencode:
    name: Test OpenCode (non-interactive)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install opencode (.deb)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./install.sh --non-interactive opencode
          
      - name: Verify opencode installation
        run: |
          which opencode || echo "opencode installed system-wide"
          dpkg -l | grep opencode || echo "opencode package installed"
          
  test-all-linux:
    name: Test 'all' option (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install all CLIs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PREFIX="${HOME}/.local/bin"
          mkdir -p "${PREFIX}"
          ./install.sh all
          
      - name: Verify installations
        run: |
          export PATH="${HOME}/.local/bin:${PATH}"
          gh --version
          jira version
          aws --version
          gdrive version || gdrive --version || echo "gdrive installed"
          slack version || slack --version
          cursor --version || echo "cursor installed"
          npx --version
